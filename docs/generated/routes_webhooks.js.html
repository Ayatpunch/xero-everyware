<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: routes/webhooks.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: routes/webhooks.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const express = require('express');
const router = express.Router();
const { webhookService } = require('../services/everyware');
const { createAndPayInvoice } = require('../services/xero');
const { getStoredTenantId } = require('../middleware/auth');

/**
 * @module routes/webhooks
 * @description Handles incoming webhooks from Everyware's payment system
 */

/**
 * @route POST /webhooks/payment
 * @description Processes payment notifications from Everyware and creates corresponding records in Xero
 * @param {Object} req.body - The webhook payload from Everyware
 * @param {string} req.body.PaymentSid - Unique payment identifier
 * @param {string} req.body.StatusID - Payment status (0 for success)
 * @param {string} req.body.PaymentAmt - Payment amount
 * @param {string} req.body.PaymentDate - Date of payment
 * @param {string} req.body.TransactionID - Transaction identifier
 * @param {string} req.body.OrderNumber - Order reference number
 * @param {string} req.body.ServiceDescription - Description of service
 * @param {string} req.body.CardType - Type of card used
 * @param {string} req.body.LastFour - Last four digits of card
 * @param {string} req.body.Phone - Customer phone number
 * @param {string} req.body.EmailAddress - Customer email address
 */

router.post('/payment', express.urlencoded({ extended: true }), async (req, res) => {
    try {
        const {
            PaymentSid,
            StatusID,
            PaymentAmt,
            PaymentDate,
            TransactionID,
            OrderNumber,
            ServiceDescription,
            CardType,
            LastFour,
            Phone,
            EmailAddress
        } = req.body;

        console.log(req.body);

        // Verify payment was successful
        if (StatusID !== "0") {
            console.error('Payment failed:', req.body.ResponseMessage);
            return res.sendStatus(200);
        }

        const storedTenantId = getStoredTenantId();
        if (!storedTenantId) {
            throw new Error('No Xero tenant ID found. Please authenticate with Xero first.');
        }

        // Format data for Xero invoice creation
        const paymentData = {
            customerName: EmailAddress || Phone,
            description: ServiceDescription,
            amount: parseFloat(PaymentAmt),
            tenantId: storedTenantId,
            reference: OrderNumber,
            paymentDate: PaymentDate,
            paymentMethod: `${CardType} ending in ${LastFour}`
        };

        // Create and pay invoice in Xero
        const { invoice, payment } = await createAndPayInvoice(paymentData);

        console.log('Payment processed:', {
            paymentSid: PaymentSid,
            transactionId: TransactionID,
            xeroInvoiceId: invoice.invoiceID
        });

        res.sendStatus(200);
    } catch (error) {
        console.error('Webhook Error:', error);
        console.error('Request body:', req.body);
        res.sendStatus(500);
    }
});

module.exports = router; </code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-config.html">config</a></li><li><a href="module-middleware_auth.html">middleware/auth</a></li><li><a href="module-routes_auth.html">routes/auth</a></li><li><a href="module-routes_invoices.html">routes/invoices</a></li><li><a href="module-routes_webhooks.html">routes/webhooks</a></li><li><a href="module-services_everyware.html">services/everyware</a></li><li><a href="module-services_xero.html">services/xero</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Feb 06 2025 09:26:37 GMT+0100 (West Africa Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
