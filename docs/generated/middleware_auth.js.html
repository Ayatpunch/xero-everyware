<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: middleware/auth.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: middleware/auth.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { XeroClient } = require('xero-node');
const { xeroConfig } = require('../config');

const xeroClient = new XeroClient({
    clientId: xeroConfig.clientId,
    clientSecret: xeroConfig.clientSecret,
    redirectUris: [xeroConfig.redirectUri],
    scopes: xeroConfig.scopes.split(' ')
});

// Store tokens and tenantId in memory (use database in production)
let tokenSet = null;
let tenantId = null;

/**
 * @module middleware/auth
 * @description Handles Xero authentication and session management
 */

/**
 * @function requireXeroAuth
 * @description Express middleware to ensure valid Xero authentication
 * @param {Object} req - Express request object
 * @param {Object} res - Express response object
 * @param {Function} next - Express next middleware function
 * @throws {Error} If authentication fails or token is invalid
 */

async function requireXeroAuth(req, res, next) {
    try {
        if (!tokenSet || tokenSet.expired()) {
            return res.redirect('/auth/xero');
        }

        // Set the token for the request
        await xeroClient.setTokenSet(tokenSet);

        // Get tenants if we don't have one
        if (!tenantId) {
            const tenants = await xeroClient.updateTenants();
            tenantId = tenants[0].tenantId;
        }

        req.xeroClient = xeroClient;
        req.xeroTenantId = tenantId;

        next();
    } catch (error) {
        console.error('Auth Error:', error);
        res.redirect('/auth/xero');
    }
}

module.exports = {
    xeroClient,
    requireXeroAuth,
    setTokenSet: (tokens) => {
        tokenSet = tokens;
    },
    getStoredTenantId: () => tenantId,
    setTenantId: (id) => { tenantId = id; }
}; </code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-config.html">config</a></li><li><a href="module-middleware_auth.html">middleware/auth</a></li><li><a href="module-routes_auth.html">routes/auth</a></li><li><a href="module-routes_invoices.html">routes/invoices</a></li><li><a href="module-routes_webhooks.html">routes/webhooks</a></li><li><a href="module-services_everyware.html">services/everyware</a></li><li><a href="module-services_xero.html">services/xero</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Feb 06 2025 09:26:37 GMT+0100 (West Africa Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
